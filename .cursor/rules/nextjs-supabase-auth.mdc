---
description: 
globs: 
alwaysApply: false
---
# Next.js App Router ã¨ Supabase Auth ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯Next.js App Routerã¨Supabase Authã‚’ä½¿ç”¨ã—ãŸã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰èªè¨¼ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ãã ã•ã„ã€‚

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

èªè¨¼é–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ï¼š
```
utils/supabase/
â”œâ”€â”€ client.ts      # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨
â”œâ”€â”€ server.ts      # ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨
â””â”€â”€ middleware.ts  # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç”¨

app/
â”œâ”€â”€ middleware.ts  # ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ page.tsx   # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ actions.ts # ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ confirm/
â”‚       â””â”€â”€ route.ts # èªè¨¼ç¢ºèªãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â””â”€â”€ private/
    â””â”€â”€ page.tsx   # èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸
```

## ğŸ”§ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

### 1. ç’°å¢ƒå¤‰æ•°è¨­å®š
`.env.local`ã«ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼š
```env
NEXT_PUBLIC_SUPABASE_URL=<your_supabase_project_url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your_supabase_anon_key>
```

### 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
[utils/supabase/client.ts](mdc:utils/supabase/client.ts)
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

### 3. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
[utils/supabase/server.ts](mdc:utils/supabase/server.ts)
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯cookieã‚’è¨­å®šã§ããªã„å ´åˆãŒã‚ã‚‹
          }
        },
      },
    }
  )
}
```

## ğŸ›¡ï¸ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š

### 1. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
[utils/supabase/middleware.ts](mdc:utils/supabase/middleware.ts)
```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT: Avoid writing any logic between createServerClient and
  // supabase.auth.getUser(). A simple mistake could make it very hard to debug
  // issues with users being randomly logged out.

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (
    !user &&
    !request.nextUrl.pathname.startsWith('/login') &&
    !request.nextUrl.pathname.startsWith('/auth')
  ) {
    // no user, potentially respond by redirecting the user to the login page
    const url = request.nextUrl.clone()
    url.pathname = '/login'
    return NextResponse.redirect(url)
  }

  // IMPORTANT: You *must* return the supabaseResponse object as it is. If you're
  // creating a new response object with NextResponse.next() make sure to:
  // 1. Pass the request in it, like so:
  //    const myNewResponse = NextResponse.next({ request })
  // 2. Copy over the cookies, like so:
  //    myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())

  return supabaseResponse
}
```

### 2. ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
[middleware.ts](mdc:middleware.ts)
```typescript
import { type NextRequest } from 'next/server'
import { updateSession } from '@/utils/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

## ğŸ” èªè¨¼ã®å®Ÿè£…

### 1. ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/utils/supabase/server'

export async function login(formData: FormData) {
  const supabase = await createClient()

  const data = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  }

  const { error } = await supabase.auth.signInWithPassword(data)

  if (error) {
    redirect('/error')
  }

  revalidatePath('/', 'layout')
  redirect('/')
}

export async function signup(formData: FormData) {
  const supabase = await createClient()

  const data = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  }

  const { error } = await supabase.auth.signUp(data)

  if (error) {
    redirect('/error')
  }

  revalidatePath('/', 'layout')
  redirect('/')
}
```

### 2. èªè¨¼ç¢ºèªãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
```typescript
import { type EmailOtpType } from '@supabase/supabase-js'
import { type NextRequest } from 'next/server'
import { createClient } from '@/utils/supabase/server'
import { redirect } from 'next/navigation'

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  const token_hash = searchParams.get('token_hash')
  const type = searchParams.get('type') as EmailOtpType | null
  const next = searchParams.get('next') ?? '/'

  if (token_hash && type) {
    const supabase = await createClient()

    const { error } = await supabase.auth.verifyOtp({
      type,
      token_hash,
    })

    if (!error) {
      redirect(next)
    }
  }

  redirect('/error')
}
```

## ğŸ”’ èªè¨¼çŠ¶æ…‹ã®ç¢ºèª

### ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®èªè¨¼ç¢ºèª
```typescript
import { redirect } from 'next/navigation'
import { createClient } from '@/utils/supabase/server'

export default async function PrivatePage() {
  const supabase = await createClient()
  const { data, error } = await supabase.auth.getUser()

  if (error || !data?.user) {
    redirect('/login')
  }

  return <p>Hello {data.user.email}</p>
}
```

## âš ï¸ é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡

### 1. èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
- **å¸¸ã«** `supabase.auth.getUser()` ã‚’ä½¿ç”¨ã—ã¦ãƒšãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·
- **çµ¶å¯¾ã«** ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å«ã‚€ï¼‰ã§ `supabase.auth.getSession()` ã‚’ä¿¡ç”¨ã—ãªã„
- `getUser()` ã¯æ¯å›Supabase Authã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†æ¤œè¨¼

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- èªè¨¼ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®å‰ã«å¿…ãš `cookies()` ã‚’å‘¼ã³å‡ºã—
- ã“ã‚Œã«ã‚ˆã‚ŠNext.jsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

### 3. ã‚¯ãƒƒã‚­ãƒ¼ã®å–ã‚Šæ‰±ã„
- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚¯ãƒƒã‚­ãƒ¼ã‚’æ›¸ãè¾¼ã‚ãªã„ãŸã‚ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã‚’è¡Œã†
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ä»¥ä¸‹ã‚’æ‹…å½“ï¼š
  1. èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ï¼ˆ`supabase.auth.getUser()` å‘¼ã³å‡ºã—ï¼‰
  2. æ›´æ–°ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™ï¼ˆ`request.cookies.set`ï¼‰
  3. æ›´æ–°ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«æ¸¡ã™ï¼ˆ`response.cookies.set`ï¼‰

## ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¨­å®š

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èªè¨¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã§ã€`Confirm signup` ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç¢ºèªURLã‚’ä»¥ä¸‹ã«å¤‰æ›´ï¼š
```
{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=email
```

## ğŸ“¦ å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```bash
npm install @supabase/supabase-js @supabase/ssr
```

## ğŸ¯ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- [ ] Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­å®š
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¨ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…
- [ ] èªè¨¼ç¢ºèªãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä½œæˆ
- [ ] ä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã§ã®èªè¨¼çŠ¶æ…‹ç¢ºèª
- [ ] ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ›´æ–°

ã“ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ã‚¢ã§åŠ¹ç‡çš„ãªNext.js App Router + Supabase Authå®Ÿè£…ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

